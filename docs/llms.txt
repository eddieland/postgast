# postgast

> BSD-licensed Python bindings to [libpg_query](https://github.com/pganalyze/libpg_query), the PostgreSQL parser extracted as a standalone C library. Parse, deparse, normalize, fingerprint, split, and scan PostgreSQL SQL from Python — with a minimal dependency footprint (just `protobuf` and the vendored C library, no Cython/Rust/C extensions needed).

## Docs

- [User Guide](https://postgast.readthedocs.io/en/latest/guide.html): Parse, deparse, normalize, fingerprint, split, scan, tree walking, AST helpers, DDL helpers, error handling
- [API Reference](https://postgast.readthedocs.io/en/latest/api.html): Full function and class signatures
- [Examples](https://postgast.readthedocs.io/en/latest/examples.html): Comprehensive usage patterns — query analysis, monitoring, formatting, batch processing, DDL tooling, tree walking, protobuf access, PL/pgSQL, tokenization
- [Upgrade Policy](https://postgast.readthedocs.io/en/latest/upgrade-policy.html): Python version support, libpg_query tracking, versioning strategy
- [Contributing](https://postgast.readthedocs.io/en/latest/contributing.html): Development setup and contribution guidelines
- [Full llms.txt](https://postgast.readthedocs.io/en/latest/llms-full.txt): Detailed reference for LLMs including API and usage guide

## Install

```bash
pip install postgast
```

## Quick Start

```python
import postgast

# Parse SQL into a protobuf AST
tree = postgast.parse("SELECT id, name FROM users WHERE active = true")

# Deparse back to SQL
sql = postgast.deparse(tree)

# Normalize (replace constants with placeholders)
postgast.normalize("SELECT * FROM users WHERE id = 42")
# => "SELECT * FROM users WHERE id = $1"

# Fingerprint (structural hash)
fp = postgast.fingerprint("SELECT * FROM users WHERE id = 42")

# Split multi-statement SQL
postgast.split("SELECT 1; SELECT 2;")
# => ["SELECT 1", "SELECT 2"]
```

## Core API

- `postgast.parse(sql)` — Parse SQL into a protobuf `ParseResult` AST
- `postgast.deparse(tree)` — Convert AST back to SQL text
- `postgast.normalize(sql)` — Replace literal constants with positional placeholders
- `postgast.fingerprint(sql)` — Compute structural hash (`FingerprintResult` with `.fingerprint` and `.hex`)
- `postgast.split(sql, method="parser"|"scanner")` — Split multi-statement SQL into individual statements
- `postgast.scan(sql)` — Tokenize SQL string with keyword classification

## Tree Walking

- `postgast.walk(tree)` — Depth-first generator yielding `(field_name, node)` tuples
- `postgast.walk_typed(tree, node_type)` — Walk filtered to a specific protobuf message type
- `postgast.Visitor` — Visitor base class; define `visit_NodeType(self, node)` methods
- `postgast.TypedVisitor` — Typed visitor variant

## AST Helpers

- `postgast.find_nodes(tree, node_type)` — Find all nodes of a given protobuf type
- `postgast.extract_tables(tree)` — Extract table names from a parse tree
- `postgast.extract_columns(tree)` — Extract column references
- `postgast.extract_functions(tree)` — Extract function names
- `postgast.extract_function_identity(sql)` — Extract function identity from DDL
- `postgast.extract_trigger_identity(sql)` — Extract trigger identity from DDL

## DDL Helpers

- `postgast.to_drop(sql)` — Generate `DROP` statement from `CREATE` DDL
- `postgast.set_or_replace(tree)` / `postgast.ensure_or_replace(sql)` — Rewrite `CREATE` to `CREATE OR REPLACE`
- `postgast.ensure_if_exists(sql)` / `postgast.set_if_exists(tree)` — Add `IF EXISTS` to DDL
- `postgast.ensure_if_not_exists(sql)` / `postgast.set_if_not_exists(tree)` — Add `IF NOT EXISTS` to DDL

## Utilities

- `postgast.format_sql(sql)` — Format SQL (deparse round-trip)
- `postgast.parse_plpgsql(sql)` — Parse PL/pgSQL function bodies
- `postgast.classify_statement(sql)` — Classify a statement (returns `StatementInfo`)
- `postgast.precedence_of(node)` / `postgast.needs_parens(parent, child, side)` — Operator precedence helpers

## Types

- `ParseResult` — Protobuf parse result (from `pg_query_pb2`)
- `FingerprintResult` — Fingerprint result with `.fingerprint` (uint64) and `.hex` (str)
- `FunctionIdentity` / `TriggerIdentity` — Identity objects for DDL helpers
- `StatementInfo` — Statement classification result
- `PgQueryError` — Exception with `.message` and `.cursorpos`
- `AstNode` — Wrapped AST node helper
