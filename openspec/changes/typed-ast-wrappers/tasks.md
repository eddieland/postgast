## Tasks

### 1. Create the code generation script

Create `scripts/generate_nodes.py` that:

- Imports `postgast.pg_query_pb2` and introspects `DESCRIPTOR.message_types_by_name`
- For each of the 277 message types, classifies every field by kind:
  - **Scalar fields** (int, bool, str, enum) — generate a `@property` that returns the raw value
  - **Singular message fields** with a concrete type (e.g., `InsertStmt.relation: RangeVar`) — generate a `@property`
    returning the concrete wrapper type
  - **Singular message fields** typed as `Node` (the oneof wrapper) — generate a `@property` that unwraps the oneof and
    returns `AstNode | None`
  - **Repeated message fields** typed as `Node` — generate a `@property` returning `list[AstNode]`
  - **Repeated message fields** with a concrete type — generate a `@property` returning `list[ConcreteType]`
- Generates `__match_args__` for each class (all non-location scalar and message fields)
- Generates the `_REGISTRY` dictionary mapping descriptor names to wrapper classes
- Generates `wrap()`, `wrap_optional()`, `wrap_list()` helper functions
- Generates the `AstNode` base class with `__slots__`, `__repr__`, `__eq__`, `__hash__`
- Writes output to `src/postgast/nodes.py` with a "DO NOT EDIT — generated by scripts/generate_nodes.py" header
- Handles edge cases: `A_Const` (which has its own `val` oneof), `List`/`IntList`/`OidList` wrapper types

**Files:** `scripts/generate_nodes.py` (new)

**Acceptance criteria:**

- Script runs successfully: `uv run python scripts/generate_nodes.py`
- Output file passes `ruff check` and `ruff format`
- Output file passes `basedpyright` type checking
- All 277 message types have corresponding wrapper classes

### 2. Generate the initial `nodes.py`

Run the generation script and commit the output.

**Files:** `src/postgast/nodes.py` (new, generated)

**Acceptance criteria:**

- File is syntactically valid Python
- File imports only from `__future__`, `google.protobuf.message`, and `postgast.pg_query_pb2`
- Every class in `pg_query_pb2.pyi` that extends `_message.Message` has a corresponding wrapper class
- The `_REGISTRY` dict has an entry for each wrapper class
- `wrap()` correctly dispatches for all message types

### 3. Write unit tests for wrapper classes

Create `tests/postgast/test_nodes.py` with tests covering:

- `wrap()` produces the correct wrapper type for each major node type (SelectStmt, InsertStmt, DeleteStmt, UpdateStmt,
  CreateStmt, RangeVar, ColumnRef, A_Expr, FuncCall, etc.)
- `Node` oneof unwrapping: wrapping a `Node` containing a `SelectStmt` returns a `SelectStmt` wrapper
- Scalar field access: `RangeVar.relname` returns a string, `RawStmt.stmt_location` returns an int
- Concrete message field access: `InsertStmt.relation` returns a `RangeVar` wrapper
- Polymorphic field access: `SelectStmt.where_clause` returns an `AstNode` subclass (not `Node` wrapper)
- Repeated field access: `SelectStmt.target_list` returns a `list` of `AstNode` instances
- `None` handling: accessing an unset optional field returns `None`
- `__match_args__` enables pattern matching: `match wrap(node): case SelectStmt(): ...`
- Structural pattern matching with field extraction: `case SelectStmt(where_clause=w): ...`
- `__repr__` returns a readable string
- `__eq__` compares by underlying protobuf equality
- Roundtrip: `wrap(tree)._pb` is the original protobuf message (no data loss)

**Files:** `tests/postgast/test_nodes.py` (new)

**Acceptance criteria:**

- All tests pass with `uv run pytest tests/postgast/test_nodes.py -v`
- Tests cover at least 10 different node types
- Pattern matching tests included

### 4. Add `walk_typed()` and `TypedVisitor`

Add typed walking/visiting that works with wrapper nodes.

- `walk_typed(node)` accepts `AstNode`, yields `tuple[str, AstNode]`
- `TypedVisitor` dispatches to `visit_SelectStmt(self, node: SelectStmt)` etc. with properly typed parameters
- Both unwrap `Node` oneof wrappers transparently (reuse logic from existing `walk.py`)

**Files:** `src/postgast/walk.py` (modified — add new functions/classes alongside existing ones)

**Acceptance criteria:**

- `walk_typed()` yields the same nodes as `walk()` but as typed wrappers
- `TypedVisitor` dispatches correctly to type-specific handlers
- Existing `walk()` and `Visitor` are unchanged (backward compatible)
- Tests in `tests/postgast/test_walk.py` updated to cover `walk_typed` and `TypedVisitor`

### 5. Update `__init__.py` re-exports

Export the new public API surface:

- `wrap` function
- `AstNode` base class
- `walk_typed` function
- `TypedVisitor` class
- Key wrapper classes that users frequently reference: `SelectStmt`, `InsertStmt`, `UpdateStmt`, `DeleteStmt`,
  `CreateStmt`, `RangeVar`, `ColumnRef`, `ResTarget`, `A_Expr`, `FuncCall`, `JoinExpr`, `SortBy`, `WithClause`,
  `BoolExpr`, `SubLink`, `TypeCast`, `TypeName`, `Alias`, `RawStmt` (from `nodes` module, aliased to avoid collision
  with `pg_query_pb2` names)

**Files:** `src/postgast/__init__.py` (modified)

**Acceptance criteria:**

- `from postgast import wrap, AstNode, walk_typed, TypedVisitor` works
- `from postgast.nodes import SelectStmt` works
- `__all__` is updated
- No import cycles

### 6. Add deparse support for wrapped types

Update `deparse()` to accept both raw `ParseResult` protobuf and the typed `ParseResult` wrapper.

**Files:** `src/postgast/deparse.py` (modified)

**Acceptance criteria:**

- `deparse(parse("SELECT 1"))` works (existing behavior)
- `deparse(wrap(parse("SELECT 1")))` works (new behavior)
- Type signature accepts both types

### 7. Add generation freshness CI check

Add a Makefile target or CI step that re-runs the generation script and verifies the output matches the committed
`nodes.py`. This catches cases where the protobuf schema is updated but the wrapper isn't regenerated.

**Files:** `Makefile` (modified)

**Acceptance criteria:**

- `make generate-nodes` runs the script
- `make check-nodes` re-generates and diffs, failing if different
- CI can call `make check-nodes` to verify freshness

### 8. Lint and test pass

Ensure the full project passes all checks.

**Acceptance criteria:**

- `make lint` passes (ruff + basedpyright)
- `make test` passes (all existing + new tests)
- No regressions in existing functionality
