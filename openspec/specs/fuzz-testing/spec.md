## ADDED Requirements

### Requirement: Crash-freedom for string-accepting functions

Each public function that accepts a SQL string input (`parse`, `normalize`, `fingerprint`, `scan`, `split`) SHALL either
return a valid result or raise `PgQueryError` for any input string. The function MUST NOT segfault, hang, raise
`SystemError`, or produce undefined behavior regardless of input content, encoding, or length.

#### Scenario: Arbitrary Unicode text does not crash parse

- **WHEN** `parse` is called with an arbitrary Unicode string generated by Hypothesis
- **THEN** the call either returns a `ParseResult` or raises `PgQueryError`

#### Scenario: Arbitrary Unicode text does not crash normalize

- **WHEN** `normalize` is called with an arbitrary Unicode string generated by Hypothesis
- **THEN** the call either returns a `str` or raises `PgQueryError`

#### Scenario: Arbitrary Unicode text does not crash fingerprint

- **WHEN** `fingerprint` is called with an arbitrary Unicode string generated by Hypothesis
- **THEN** the call either returns a `FingerprintResult` or raises `PgQueryError`

#### Scenario: Arbitrary Unicode text does not crash scan

- **WHEN** `scan` is called with an arbitrary Unicode string generated by Hypothesis
- **THEN** the call either returns a `ScanResult` or raises `PgQueryError`

#### Scenario: Arbitrary Unicode text does not crash split

- **WHEN** `split` is called with an arbitrary Unicode string generated by Hypothesis
- **THEN** the call either returns a `list[str]` or raises `PgQueryError`

### Requirement: Crash-freedom for deparse with mutated ASTs

The `deparse` function SHALL either return a valid SQL string or raise `PgQueryError` when given a protobuf
`ParseResult` that has been parsed from valid SQL and then mutated. It MUST NOT segfault or produce undefined behavior.

#### Scenario: Parse-then-deparse roundtrip does not crash

- **WHEN** a valid SQL statement is parsed into a `ParseResult` and then deparsed
- **THEN** the call returns a SQL string without crashing

#### Scenario: Deparsing a mutated parse tree does not crash

- **WHEN** a valid SQL statement is parsed, the resulting `ParseResult` is mutated (fields cleared, values changed), and
  then deparsed
- **THEN** the call either returns a `str` or raises `PgQueryError`

### Requirement: SQL-biased input generation

The fuzz test input strategy SHALL include SQL-flavored inputs in addition to purely random text. This MUST include
strings composed of SQL keywords, operators, punctuation, identifiers, and literals to exercise interesting parser code
paths beyond what random bytes would reach.

#### Scenario: SQL fragment inputs exercise parser paths

- **WHEN** fuzz tests run with the SQL-biased strategy
- **THEN** generated inputs include combinations of SQL keywords (`SELECT`, `FROM`, `WHERE`, etc.), operators (`=`,
  `<>`, `||`), punctuation (`;`, `(`, `)`, `'`, `"`), and numeric/string literals

### Requirement: Edge-case input coverage

The fuzz test input strategy SHALL include known edge-case inputs: empty strings, strings containing null bytes, very
long strings (up to 100KB), and deeply nested parenthesized expressions.

#### Scenario: Empty string input

- **WHEN** any string-accepting function is called with an empty string `""`
- **THEN** the call either returns a valid result or raises `PgQueryError`

#### Scenario: Null byte input

- **WHEN** any string-accepting function is called with a string containing embedded null bytes
- **THEN** the call either returns a valid result or raises `PgQueryError`

#### Scenario: Very long input

- **WHEN** any string-accepting function is called with a string up to 100KB in length
- **THEN** the call either returns a valid result or raises `PgQueryError`

### Requirement: Fuzz tests are isolated from the default test suite

Fuzz tests SHALL be marked with `@pytest.mark.fuzz` and MUST NOT run as part of the default `make test` target. A
separate `make fuzz` target SHALL be provided to run fuzz tests on demand.

#### Scenario: Default test run excludes fuzz tests

- **WHEN** `make test` is run
- **THEN** no tests marked with `@pytest.mark.fuzz` are executed

#### Scenario: Fuzz target runs fuzz tests

- **WHEN** `make fuzz` is run
- **THEN** all tests marked with `@pytest.mark.fuzz` are executed

### Requirement: Configurable example count

The number of Hypothesis examples per test SHALL default to 1000 and MUST be overridable via the
`HYPOTHESIS_MAX_EXAMPLES` environment variable.

#### Scenario: Default example count

- **WHEN** fuzz tests run without `HYPOTHESIS_MAX_EXAMPLES` set
- **THEN** Hypothesis generates 1000 examples per test function

#### Scenario: Custom example count via environment variable

- **WHEN** fuzz tests run with `HYPOTHESIS_MAX_EXAMPLES=100`
- **THEN** Hypothesis generates 100 examples per test function
